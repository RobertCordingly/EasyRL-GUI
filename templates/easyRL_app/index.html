{% extends "easyRL_app/base.html" %}
{% load static %}
{% block content %}
  <div class="container-fluid">
      <div class="card text-center">
          <div class="card-header">
            <ul class="nav nav-pills card-header-pills">
              <li class="nav-item">
                <button id="btn_train" class="btn btn-primary" style="margin:5px;">Train</button>
              </li>
              <li class="nav-item">
                <button class="btn btn-primary"style="margin:5px;">Halt</button>
              </li>
              <li class="nav-item">
                <button class="btn btn-primary"style="margin:5px;">Test</button>
              </li>
              <li class="nav-item">
                <button class="btn btn-primary"style="margin:5px;">Reset</button>
                </li>  
                <li class="nav-item dropdown">
                  <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false" style="margin:5px;">Model </a>
                  <div class="dropdown-menu">
                    <a class="dropdown-item" href="#">Save</a>
                    <div class="dropdown-divider"></div>
                    <a class="dropdown-item" href="#">Load</a>
                  </div>
                </li> 
                <li class="nav-item">
                  <button class="btn btn-primary"style="margin:5px;">Save Result</button>
                </li>  
                <li class="nav-item"><a href='/easyRL_app/logout'>
                  <button class="btn btn-primary"style="margin:5px;">Sign out</button></a>
                </li>                                                                               
            </ul>
          </div>
          <!-- Carousel -->
          <div class="card-body">
              <h4>Environment</h4>
              <div class="row justify-content-center">
                  <div id="carouselExampleControlsNoTouching" class="carousel mbr-slider slide col-md-3" data-bs-touch="false" data-bs-interval="false">
                      <div class="carousel-inner">
                        {% for file in files %}
                        {% if file == 'alien.jpg' %}
                        <div class="carousel-item active">
                          <div class="d-flex justify-content-center w-100 h-100">
                              <img src="{% static 'easyRL_app/images/'%}{{file}}" data-name="{{file}}" alt="...">
                          </div>
                          </div>                        
                          {% else %}
                          <div class="carousel-item">
                            <div class="d-flex justify-content-center w-100 h-100">
                              <img src="{% static 'easyRL_app/images/'%}{{file}}" data-name="{{file}}" alt="...">
                            </div>
                          </div>
                          {% endif %}
                        {% endfor %} 
                      </div>
                      <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleControlsNoTouching" data-bs-slide="prev">
                      <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                      <span class="visually-hidden">Previous</span>
                      </button>
                      <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleControlsNoTouching" data-bs-slide="next">
                      <span class="carousel-control-next-icon" aria-hidden="true"></span>
                      <span class="visually-hidden">Next</span>
                      </button>
                  
                  </div>
              </div>  
              <br/>               
              <h5 id="file-name" class="card-title">file_name.jpg</h5>
              <button class="btn btn-primary"><span class=""><i class="bi-card-image"></i></span> Select Environment</button>
          </div>
      </div>
      <br/>
      <!-- Tabs & dropdowns-->
           <!-- Drop downs -->
      <div class="row justify-content-center">
           <div class="col-md-3">
              <select class="form-select" id="agent-select" size="3" aria-label="Default select example">
                  <option selected>--Select Agent--</option>
                  <option value="1">Deep Q</option>
                  <option value="2">Q Learning</option>
                  <option value="3">DRQN</option>
                  <option value="1">ADRQN</option>
                  <option value="2">Double Dueling Deep Q Native</option>
                  <option value="3">DRQN Native</option>
                  <option value="1">Converging DRQN Native</option>
                  <option value="2">PPO Native</option>
                  <option value="3">Reinforcemnt Native</option>
                  <option value="1">ActorCritic Native</option>
                  <option value="2">SARSA</option>
              </select>
            </div> 
           
            <div class="col-md-3">
              <select class="form-select" size="3" aria-label="Default select example">
                  <option selected>--Select Buffer--</option>
                  <option value="1">Hindsight Replay Buffer</option>
                  <option value="2">Prioritize Replay Buffer</option>
              </select> 
            </div>
         
            <div class="col-md-3">           
              <select class="form-select" size="3" aria-label="Default select example">
                <option selected>--Select Host Environment--</option>
                <option value="1">EC2</option>
                <option value="2">Kubeflow</option>
                <option value="3">...</option>
                <option value="3">...</option>
                <option value="3">...</option>                               
              </select> 
            </div> 
          <br/>

        </div>                                       
      </div>   
      <br/>  
      <div class="row">
          <!-- Tabs -->
          <div class="col-md-12">
            <ul class="nav nav-tabs" id="myTab" role="tablist">
                <li class="nav-item" role="presentation">
                  <button class="nav-link active" id="hp-tab-0" data-bs-toggle="tab" data-bs-target="#hp" type="button" role="tab" aria-controls="hp" aria-selected="true">Hyper Parameters <i class="bi-dash-circle-fill"  style="color: red"></i></button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="add-model-tab" type="button" >Add <i class="bi-plus-circle-fill" style="color: #0b5ed7"></i></button>
                </li>
            </ul>
            <div class="col-md-12">
              <div class="tab-content" id="myTabContent" style="width: 100%;">
                <div class="tab-pane fade show active" id="hp" role="tabpanel" aria-labelledby="hp-tab-0">
                  <form method="post" style="margin-top: 15px;">{% csrf_token %}
                    <div class="container-fluid">
                      <div class="row">
                        <div class="slider-container col-3">
                          <label>Gamma</label>
                          <div class=""  >{{form.gamma}}</div>
                          <div class="" style="margin: 0px 100px 0px 100px;">{{form.gamma_text}}</div>
                        </div>
                        <div class="col-md-3">
                          <label>Number of Episodes</label>
                        <div class="col-md-7"  >{{form.num_episodes}}</div>
                      </div>
                      </div>
                      <div class="row">
                        <div class="slider-container col-3">
                          <label>Min Epsilon</label>
                          <div class="">{{form.min_epsilon}}</div>
                          <div class="" style="margin: 0px 100px 0px 100px;">{{form.min_text}}</div>
                        </div>
                        <div class="col-md-3">
                        <label>Max Memory</label>
                        <div class="col-md-7" >{{form.max_memory}}</div>
                        </div>
                      </div> 
                      <div class="row">
                        <div class="slider-container col-3">
                          <label>Max Epsilon</label>
                          <div class=""  >{{form.max_epsilon}}</div>
                          <div class="" style="margin: 0px 100px 0px 100px;">{{form.max_text}}</div>
                        </div>
                        <div class="col-md-3">
                        <label>Target Update Iterval</label>
                        <div class="col-md-7"  >{{form.target_update}}</div>
                      </div> 
                      <div class="row">
                        <div class="slider-container col-3">
                          <label>Batch Size</label>
                          <div class=""  >{{form.batch}}</div>
                          <div class="" style="margin: 0px 100px 0px 100px;">{{form.batch_text}}</div>
                        </div>
                        <div class="col-md-3">
                        <label>Max Size</label>
                        <div class="col-md-7">{{form.max_size}}</div>
                        </div>
                      </div> 
                      <div class="row">
                        <div class="slider-container col-3">
                          <label>Decay Rate</label>
                          <div class=""  >{{form.decay_rate}}</div>
                          <div class="" style="margin: 0px 100px 0px 100px;">{{form.decay_text}}</div>
                        </div>
                        <div class="slider-container col-3">
                          <label>Display Episode Speed</label>
                          <div class=""  >{{form.display_ep_speed}}</div>
                          <div class="" style="margin: 0px 100px 0px 100px;">{{form.display_text}}</div>
                        </div>
                      </div>                                      
                    </div>  
                    <br/>                
                    <button class="btn btn-primary" type="submit">Submit form</button>
                  </form>
                </div>
              </div>
            </div>
          </div>
      </div>
  </div> 
  <script src="{% static 'easyRL_app/scripts/jquery-3.5.1.min.js' %}"></script> 
  <script type="text/javascript"> 
    // Sets the Environment label
    $(document).ready(function(){
      var src = $('.active').find('img').attr('src');
      src = src.slice(26,-4);
      $("#file-name").html(src);

      $( ".target" ).change(function() {

      });

      $("#batch-slider").on('input',function(){
        var newval=$(this).val();
        $("#batch-text").val(newval);
      }); 
      $("#gamma-slider").on('input',function(){
        var newval=$(this).val();
        $("#gamma-text").val(newval);
      }); 
      $("#min-slider").on('input',function(){
        var newval=$(this).val();
        $("#min-text").val(newval);
      }); 
      $("#max-slider").on('input',function(){
        var newval=$(this).val();
        $("#max-text").val(newval);
      }); 
      $("#decay-slider").on('input',function(){
        var newval=$(this).val();
        $("#decay-text").val(newval);
      }); 
      $("#display-slider").on('input',function(){
        var newval=$(this).val();
        $("#display-text").val(newval);
      });                 
    });

    $('#add-model-tab').click(function (e) {
        var nextTab = $('#myTab li').length+1;    
      // create the tab
      
      $("#myTab li:nth-child(2)").before($('<li class="nav-item" role="presentation"><button class="nav-link" id="hp-tab'+nextTab+'" data-bs-toggle="tab" data-bs-target="#hp'+nextTab+'" type="button" role="tab" aria-controls="hp'+nextTab+'" aria-selected="false">Hyper Parameters'+nextTab+' <i class="bi-dash-circle-fill"  style="color: red"></i></button></li>'));
      // create the tab content
    
var form =       '<form method="post" style="margin-top: 15px;">{% csrf_token %}'+
                    '<div class="container-fluid">'+
                      '<div class="row">'+
                       '<div class="slider-container col-3">'+
                          '<label>Gamma</label>'+
                          '<div class=""  >{{form.gamma}}</div>'+
                          '<div class="" style="margin: 0px 100px 0px 100px;">{{form.gamma_text}}</div>'+
                        '</div>'+
                        '<div class="col-md-3">'+
                          '<label>Number of Episodes</label>'+
                        '<div class="col-md-7"  >{{form.num_episodes}}</div>'+
                      '</div>'+
                      '</div>'+
                      '<div class="row">'+
                        '<div class="slider-container col-3">'+
                          '<label>Min Epsilon</label>'+
                          '<div class="">{{form.min_epsilon}}</div>'+
                          '<div class="" style="margin: 0px 100px 0px 100px;">{{form.min_text}}</div>'+
                        '</div>'+
                        '<div class="col-md-3">'+
                          '<label>Max Memory</label>'+
                          '<div class="col-md-7" >{{form.max_memory}}</div>'+
                          '</div>'+
                          '</div>'+ 
                          '<div class="row">'+
                            '<div class="slider-container col-3">'+
                              '<label>Max Epsilon</label>'+
                              '<div class=""  >{{form.max_epsilon}}</div>'+
                              '<div class="" style="margin: 0px 100px 0px 100px;">{{form.max_text}}</div>'+
                              '</div>'+
                              '<div class="col-md-3">'+
                                '<label>Target Update Iterval</label>'+
                                '<div class="col-md-7"  >{{form.target_update}}</div>'+
                                '</div>'+ 
                                '<div class="row">'+
                                  '<div class="slider-container col-3">'+
                                    '<label>Batch Size</label>'+
                                    '<div class=""  >{{form.batch}}</div>'+
                                    '<div class="" style="margin: 0px 100px 0px 100px;">{{form.batch_text}}</div>'+
                                    '</div>'+
                                    '<div class="col-md-3">'+
                                      '<label>Max Size</label>'+
                                      '<div class="col-md-7">{{form.max_size}}</div>'+
                                      '</div>'+
                                      '</div>'+ 
                                      '<div class="row">'+
                                        '<div class="slider-container col-3">'+
                                          '<label>Decay Rate</label>'+
                          '<div class=""  >{{form.decay_rate}}</div>'+
                          '<div class="" style="margin: 0px 100px 0px 100px;">{{form.decay_text}}</div>'+
                          '</div>'+
                        '<div class="slider-container col-3">'+
                          '<label>Display Episode Speed</label>'+
                          '<div class=""  >{{form.display_ep_speed}}</div>'+
                          '<div class="" style="margin: 0px 100px 0px 100px;">{{form.display_text}}</div>'+
                          '</div>'+
                      '</div>'+                                      
                    '</div>'+  
                    '<br/>'+              
                   '<button class="btn btn-primary" type="submit">Submit form</button>' +
                  '</form>';
var form2 = '<div style="margin-top:50px;"><input type="text">TEST</input></div>';

      $('<div class="tab-pane fade" id="hp'+nextTab+'" role="tabpanel" aria-labelledby="hp-tab'+nextTab+'">'+form+'</div>').appendTo('.tab-content');;
      // make the new tab active
      $('#myTab').on('click', function (e) {
        e.preventDefault()
        $(this).tab('show')
      });
    });

    // updates the environment label.   
    $('#carouselExampleControlsNoTouching').on('slid.bs.carousel', function () {
      var src = $('div > .active').find('img').attr('src');
      var b = src.slice(26,-4);
      $("#file-name").html(b);
      $("#agent-select")
    });
    function updateSelect(fileName){
      var games = {
            'Cart Pole' : ['Deep Q', 'DRQN', 'ADRQN','Double, Dueling Deep Q Native', 'DRQN Native, PPO Native', 'Reinforce Native', 'ActorCritic Native'],
            'Cart Pole Descrete' : ['Deep Q', 'Q Learning', 'DRQN', 'ADRQN','Double, Dueling Deep Q Native', 'DRQN Native, PPO Native', 'Reinforce Native', 'ActorCritic Native','SARSA'],
            'Frozen Lake': ['Deep Q', 'Q Learning', 'DRQN', 'ADRQN','Double, Dueling Deep Q Native', 'DRQN Native, PPO Native', 'Reinforce Native', 'ActorCritic Native','SARSA'],
            'Pendulum' : ['Deep Q', 'DRQN', 'ADRQN','Double, Dueling Deep Q Native', 'DRQN Native, PPO Native', 'Reinforce Native', 'ActorCritic Native'],
            'Acrobot': ['Deep Q', 'DRQN', 'ADRQN','Double, Dueling Deep Q Native', 'DRQN Native, PPO Native', 'Reinforce Native', 'ActorCritic Native'],
            'Mountain Car' : ['Deep Q', 'DRQN', 'ADRQN','Double, Dueling Deep Q Native', 'DRQN Native, PPO Native', 'Reinforce Native', 'ActorCritic Native'],
            'default' : ['DRQN', 'ADRQN', 'Conv DRQN Native']
          };
        alert( "Handler for .change() called." );
        var options = "";
        switch(fileName){
          case 'Cart Pole':
            break;
          case 'Cart Pole Descrete':
            break;
          case 'Fronzen Lake':
            break;
          case 'Mountain Car':
            break;           
          default:
        }     
    }
    
    // Train button
	$("#btn_train").click(function () {
		// get values from sliders
		//var slider = $(this).val();
		
		$.ajax({
			url: '/easyRL_app/train/',
			data: {
				"environment": 1,
	            "agent": 1,
	            "episodes": 50,
	            "steps": 200,
	            "gamma": 0.97,
	            "minEpsilon": 0.1,
	            "maxEpsilon": 1.0,
	            "decayRate": 0.018,
	            "batchSize": 32,
	            "memorySize": 1000,
	            "targetInterval": 200
			},
			dataType: 'text',
			success: function (data) {
				if (data == "0") {
					// code to display images from S3
					alert("The job is running")
				}
				else {
					// something wrong in here
					alert("something wrong in here")
				}
			}
		});
	});
    
  </script>  
{%endblock%}